<!doctype html>
<html lang="en">

	<head>

		<title>The National Lottery</title>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
        <meta content="width=800; height:480; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;"/>
		<link rel="stylesheet" type="text/css" href="css/generic.css">
        <link rel="stylesheet" type="text/css" href="css/scan.css">

        <script type="text/javascript" src="libs/jquery.min.js"></script>
        <script type="text/javascript" src="libs/jquery.mobile-1.3.2.min.js"></script>
		<script type="text/javascript" src="libs/jquery-ui.js"></script>

		<script>

			var ua = navigator.userAgent.toLowerCase();
			var isLive = ua.indexOf("android") > -1; //&& ua.indexOf("mobile");
			//var isLive = true;
			var testing = false;

			////////////
			/*/ TEST /*/
			////////////

			var testCltIsDBG = 'false';
			//
			var testScenario = 2; // 1=SCRATCHSCAN 2=DBGSCAN 3=QRSCAN 5=MATCHTWO
			//
			var testBarcodeErrorCode = '-2'; // 0=READ || -1 -2 ERROR
			var testBarcodeType = ''; // ITF || QR
			var testBarcodeValue = '';
			var testBarcodeGameName = ''; // Scratchcard, Lotto, Euromillions, Thunderball, Lotto HotPicks.
			//
			var testInquiryErrorCode = '1'; // 1=WINNER 2=TOP 3=LOSE
			var testInquiryResultCode = '0'; // 0=READ || -1 -2 ERROR
			var testInquiryPrizeValue = '42100'; // 50000, 5000000
			var testInquiryMessage1 = ''; // NUMBER OF LUCKY DIPS WON

			/////////////////
			/*/ VARIABLES /*/
			/////////////////

			var ticketIsDbg;
			var signedOn = '';
			var cltIsDBG = 'true';

			//////////////
			/*/ KEYPAD /*/
			//////////////

			var inputtedKeypadData = '';
			var repeatTapTimeout = false;
			var delayAmt = 100;
			//var loadingStarted = false; // prevent loading bar from stalling

			/////////////
			/*/ TIMER /*/
			/////////////

			var touchTimer;
			var touchTimeout = 60000; // 1min
			var holdingScreenTimer;
			var holdingScreenTimeout = 180000; // 3mins

			//////////////
			/*/ KEYPAD /*/
			//////////////

			var inputtedKeypadData = '';

			///////////////////
			/*/ LOADING BAR /*/
			///////////////////

			//var loadingbarcomplete = false;
			//var dataloadingcomplete = false;

			var screenSwiped;

			var barcodeValue     = '';
			var barcodeGameName  = '';
			var barcodeErrorCode = '';
			var barcodeMessage1  = '';
			var barcodeMessage2  = '';

			var inquiryGameName	     = '';
			var inquiryResCode       = '';
			var inquiryErrCode	     = '';
			var inquiryPrizeValue	 = '';
			var inquiryGamePrice     = '';
			var inquiryGameCloseDate = '';
			var inquiryLastClaimDate = '';
			var inquiryMessage1	     = '';
			var inquiryMessage2      = '';

			var prizeValueInPounds = '';
			var prizeValueString = '';
			var numberOfLuckyDipsWon = '';

			var loseImages = [
				'url(images/scan/lose1.png)',
				'url(images/scan/lose2.png)',
				'url(images/scan/lose3.png)',
				'url(images/scan/lose4.png)',
				'url(images/scan/lose5.png)'
			];

			////////////
			/*/ INIT /*/
			////////////

			function init(){
				console.log("Scan init");
				if(!isLive){
					getTestScenarioData();
				} else {
					ESMM.setShowInterruptable('false');
				}

				hideAllScreens();

				$("body").show();
				$(".content-overlay").show();

				$('.screen').css('position','absolute');

				preload([
					'images/generic/btn-enter-over.png',
					'images/generic/btn-continue-over.png',
					'images/generic/btn-confirm-over.png',
					'images/generic/btn-close-over.png'
				]);

				touchEventsInit();

				console.log("Starting Timeout...");
				startTimeout();

				requestSignedOnState();
				//callData('barcode');//handled on above response when signed on
			}

			function preload(arrayOfImages) {
				$(arrayOfImages).each(function(){
					//$('<img/>')[0].src = this;
					// Alternatively you could use:
					 (new Image()).src = this;
				});
			}

			////////////
			/*/ TEST /*/
			////////////

			function getTestScenarioData(){
				console.log("getTestScenarioData");

				switch(testScenario){

					case 1:
						// TEST SCENARIO 1: SCRATCHCARD SCAN
						testBarcodeType = 'ITF';
						testBarcodeValue = '1000001010101000';
						testBarcodeGameName = 'SCRATCHCARD GAME';
					break;

					case 2:
						// TEST SCENARIO 3: DBG TICKET SCAN
						testBarcodeType = 'ITF';
						testBarcodeValue = '000000000000000018';
						testBarcodeGameName = '';
						//testBarcodeGameName = 'Euromillions';
						//testBarcodeGameName = 'Thunderball';
						//testBarcodeGameName = 'Lotto HotPicks';
					break;

					case 3:
						// TEST SCENARIO 2: QRCODE SCAN
						testBarcodeType = 'QR_CODE';
						//testBarcodeValue = 'LOT79:/001/W8/V7/N8/D437/B7/L0000000/A22400/S020926273132/S041319242635/S070816274145/S182023284749/S051316172143/S012229324049/A90F0B46';
						//testBarcodeValue = 'LOT79: /001 /W8 /V7 /N1 /D3/B7 /L0000000 /A22400 /S020926273132 /S041319242635 /S070816274145 /S040713203940 /S182023284749 /S051316172143 /S012229324049 /A90F0B46';
						//testBarcodeValue = 'LOT79: /001 /W8 /V7 /N8 /D36 /B7 /L0100000 /A22400 /S020926273132 /S070816274145 /S040713203940 /S182023284749 /S051316172143 /S012229324049/A90F0B46';
						//testBarcodeValue = 'LOT79:/001/W27/V178/N8/D36/B5/P12345/A08000/S01/S0211/S031221/S04132231/S0615243342/A90F0B46';
						//testBarcodeValue = 'http://www.lexfrost.net';
						//testBarcodeGameName = 'Lotto';
						//testBarcodeGameName = 'Euromillions';
						//testBarcodeGameName = 'Thunderball';
						//testBarcodeGameName = 'Lotto HotPicks';
						testBarcodeValue = 'LOT79:/001/W8/V7/N1/D3/B7/L0000000/A22400/S020926273132/S041319242635/S070816274145/S040713203940/S182023284749/S051316172143/S012229324049/A90F0B46';

					break;

					case 4:
						// TEST SCENARIO 4: SC CLT DBG SCAN
						console.log("***TEST SCENARIO 4***");
						testCltIsDBG = 'false';
						//
						testBarcodeErrorCode = '-2';
						testBarcodeType = 'ITF';
						testBarcodeGameName = '';
						//testBarcodeGameName = 'Lotto';
						//testBarcodeGameName = 'Euromillions';
						//testBarcodeGameName = 'Thunderball';
						//testBarcodeGameName = 'Lotto HotPicks';
					break;

					case 5:
						// TEST SCENARIO 5: MATCH TWO
						console.log("***TEST SCENARIO 5***");
						testCltIsDBG = 'true';
						//
						testBarcodeErrorCode = '0';
						testBarcodeType = 'ITF';
						testBarcodeGameName = 'Lotto';
						//testBarcodeGameName = 'Euromillions';
						//testBarcodeGameName = 'Thunderball';
						//testBarcodeGameName = 'Lotto HotPicks';
						//
						testInquiryPrizeValue = '1000'; // PRIZE VALUE
						testInquiryMessage1 = '1' // LUCKY DIPS WON
					break;

				}
			}

			//////////////////
			/*/ CLT IS DBG /*/
			//////////////////

			function requestSignedOnState(){
				if(isLive){
					ESMM.requestFromObserver('signOnState', '/data/signonstateobserver/signon.xml');
				} else {
					responseFromObserver("signOnState","debug");
				}
			}

			function signedOnStateXMLLoaded(){
				if (signedOn != '' && cltIsDBG != '' && signedOn != null && cltIsDBG != null){
					console.log("signedOnStateXMLLoaded :: " + signedOn +" :: "+ cltIsDBG);
					callData('barcode');
				} else {
					console.log("signedOnStateXMLLoaded - Data Error");
					changeScreen("ERROR");
				}
			};

			///////////////
			/*/ TIMEOUT /*/
			///////////////

			function startTimeout() {
				clearTimeout(this.touchTimer);
				var _this = this;
				this.touchTimer = setTimeout(function(){_this.exitApp();}, this.touchTimeout);
				console.log("startTimeout();" + this.touchTimeout);
			};

			function stopTimeout() {
				console.log("stopTimeout()");
				clearTimeout(this.touchTimer);
			};

			function exitApp() {
				console.log("ESMM.showFinished");
				ESMM.setShowInterruptable('true');
				window.setTimeout(function(){ESMM.showFinished();}, 50);
			};

			////////////////////
			/*/ TOUCH EVENTS /*/
			////////////////////

			function touchEventsInit(){

				// touchTimeout
				$('body').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					//if (loadingStarted != true){
						//console.log("startTimeout");
						startTimeout();
					//}
				});

				$('.exit-btn, .dbg-screen-close-btn').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						ESMM.setShowInterruptable('true');
						window.setTimeout(function(){ESMM.showFinished();}, 50);
					}
				});

				$('#find-virn-screen-btn').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					screenSwiped = false;
				});

				$('#find-virn-screen-btn').on("swipe",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					screenSwiped = true;
				});

				$('#find-virn-screen-exit-btn').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						$('#textbox1').val('');
						$('#textbox2').val('');
						$('#textbox3').val('');
						$('#textbox4').val('');
						inputtedKeypadData = '';
						//
						changeScreen("SC_KEYPAD_CANT_FIND_CODE_REMOVE");
						startTimeout();
					}
				});

				$('#check-virn-screen-back').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						changeScreen("SC_KEYPAD_VERIFY_REMOVE");
						startTimeout();
					}
				});

				$('#check-virn-screen-confirm').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						changeScreen("SC_KEYPAD_VARIFY_COMPLETE");
					}
				});


				$('.dbg-screen-close-btn-closed').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						changeScreen("QR_ORDER_CLOSED");
					}
				});

				////////////////////////
				/*/ SC_KEYPAD EVENTS /*/
				////////////////////////

				$('.sc-screen1-continue-btn').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						changeScreen("SC_SCREEN1_CONTINUE");
					}
				});

				var downPress = '';
				var upPress = '';
				var uncompletedDownCharacter = '';

				$('#keypad-column2 div').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					var $this = $(this);
					var character = $this.html();
					downPress = character;

					if (uncompletedDownCharacter == ''){
						uncompletedDownCharacter = character;
					}

					screenSwiped = false;
					startTimeout();
				});

				$('#keypad-column2 div').on("swipe",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					screenSwiped = true;
				});

				$('#keypad-column2 div').on("vmouseup",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(screenSwiped == false){

						var $this = $(this);
						var character = $this.html();
						if (character != "Delete"){
							$('.output').append(''+character+"u");
							upPress = character;
						}

						if (uncompletedDownCharacter == character){
							uncompletedDownCharacter = '';
						}

						if(uncompletedDownCharacter == ''){

							if(!repeatTapTimeout){
								repeatTapTimeout = true;

								var _this = this;
								var $this = $(this);
								var character = $this.html();

								// add and remove rollover state
								$this.addClass("buttonActive");
								window.setTimeout(function(){$this.removeClass("buttonActive");}, delayAmt);
								window.setTimeout(function(){repeatTapTimeout = false;}, 50);

								// check which key
								if ($this.hasClass('key')){
									inputtedKeypadData = inputtedKeypadData + character;
								}
								else if (character == "DELETE"){
									inputtedKeypadData = inputtedKeypadData.substr(0, inputtedKeypadData.length - 1);
								}
								else if (character == "CLEAR"){
									inputtedKeypadData = '';
								}

								// check and crop length
								if(inputtedKeypadData.length >= 4){
									 inputtedKeypadData = inputtedKeypadData.substr(0, 4);
									$(".key-enter").css({ opacity: 1 });
								} else {
									$(".key-enter").css({ opacity: 0.3 });
								}

								setTextboxContent();
							}

						}
						// miss only a single instance of mixed vmouseup and vmousedown calls
						uncompletedDownCharacter = '';
					}
				});








				$('.dbg-screen1-continue-btn').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						changeScreen("DBG_SCREEN1_SELECTED");
					}
				});

				$('.scan-qr-confirm-btn').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, delayAmt);
						//
						changeScreen("QR_ORDER_SEND");
					}
				});


				$('.key-enter').on("vmousedown",function(event){
					event.stopPropagation();
					event.preventDefault();
					//
					if(!repeatTapTimeout){
						repeatTapTimeout = true;
						var $this = $(this);
						$this.addClass("buttonActive");
						window.setTimeout(function(){$this.removeClass("buttonActive");repeatTapTimeout = false;}, 300);
						//
						//console.log("HHH"+inputtedKeypadData.length);
						//console.log("Inputted Keypad Data: "+inputtedKeypadData);
						if(inputtedKeypadData.length == 4){
							changeScreen("SC_KEYPAD_COMPLETE");
						}
					}
				})


				/*/ END BUTTONS /*/

			}

			function setTextboxContent(){
				//console.log("inputtedKeypadData: "+inputtedKeypadData);
				$('#textbox1').val(inputtedKeypadData.substr(0, 1));
				$('#textbox2').val(inputtedKeypadData.substr(1, 1));
				$('#textbox3').val(inputtedKeypadData.substr(2, 1));
				$('#textbox4').val(inputtedKeypadData.substr(3, 1));
			}

			///////////////////
			/*/ SUBMIT DATA /*/
			///////////////////

			/*/function submitVIRNData(){
				console.log("submitVIRNData(); "+inputtedKeypadData);
				touchTimeout = 15000;
				startTimeout();
				if(isLive){
					ESMM.sendData(inputtedKeypadData);
				} else {
					callData('inquiry');
				}
			}/*/

			function submitVIRNData(typeString){
				/*/ TEST /*/
				if(testing){$(".content-overlay .header").append(typeString + " | ");}
				/*/ TEST /*/

				console.log("submitVIRNData(); "+inputtedKeypadData);
				//touchTimeout = 60000;
				startTimeout();

				if(isLive){
					if(typeString == "DBG"){
						console.log("ESMM.sendData(barcodeValue,''); "+barcodeValue);
						//ESMM.sendData(barcodeValue,'');
						ESMM.sendData("");
						//callData('inquiry'); // called from whenResponseReady() callback
					} else {
						console.log("ESMM.sendData(barcodeValue,inputtedKeypadData); "+barcodeValue+" : "+inputtedKeypadData);
						//ESMM.sendData(barcodeValue,inputtedKeypadData);
						ESMM.sendData(inputtedKeypadData);
						//callData('inquiry'); // called from whenResponseReady() callback
					}
				} else {
					callData('inquiry'); // test only
				}
			}

			function whenResponseReady(){ // callback response from system
               console.log("Have response!");
               callData('inquiry');
			}

			//////////////
			/*/ SCREEN /*/
			//////////////

			function changeScreen(scrn){

				switch(scrn){

					case "SC_SCREEN1":
						hideAllScreens();

						$(".key-enter").css({ opacity: 0.3 });
						$("#SC_SCREEN1").fadeIn('slow');
						break;
					case "SC_SCREEN1_CONTINUE":
						$("#SC_SCREEN1").fadeOut('slow','swing',function(){
							changeScreen("SC_KEYPAD");
						});
						break;

					case "SC_KEYPAD":
						//console.log("SC_KEYPAD");
						$('#textbox1').val('');
						$('#textbox2').val('');
						$('#textbox3').val('');
						$('#textbox4').val('');
						$('#keypad-content h3').text(barcodeGameName);
						$("#keypad-screen").fadeIn('slow');
						break

					case "SC_KEYPAD_COMPLETE":
						console.log("SC_KEYPAD_COMPLETE");
						$("#keypad-screen").fadeOut('slow','swing',function(){
							changeScreen("SC_SEND_VIRN");
						});
						break;

					case "SC_SEND_VIRN":
						$("#load-screen").fadeIn('slow');
						submitVIRNData();
						break


					case "WINNER_TIER_0":
						console.log("WINNER_TIER_0 - LUCKY DIPS ONLY!");
						$("#winner-screen1").css('background-image','url(images/scan/lotto-winner1.png)');
						if(numberOfLuckyDipsWon == 1){
							$("#winner-screen1 h1").html("YOU'VE WON<br>A LOTTO LUCKY DIP").css("fontSize","56px").css("wordSpacing","2px").css("lineHeight","46px");
							$("#winner-screen1 h3").html("<h3>PLEASE HAND THIS TICKET TO THE RETAILER<br>SO THEY CAN ISSUE YOUR FREE LUCKY DIP</h3>");
						} else {
							$("#winner-screen1 h1").html("YOU'VE WON<br>" + numberOfLuckyDipsWon + " LOTTO LUCKY DIPS").css("fontSize","56px").css("wordSpacing","2px").css("lineHeight","46px");
							$("#winner-screen1 h3").html("<h3>PLEASE HAND THIS TICKET TO THE RETAILER<br>SO THEY CAN ISSUE YOUR FREE LUCKY DIPS</h3>");
						}
						$("p.dbg-winner").css("paddingTop","35px");
						$("#winner-screen1").fadeIn('slow');
						break;

					case "WINNER_TIER_1a":
						console.log("WINNER_TIER_1a - VALUE<=100");
						if(barcodeGameName == "Lotto"){$("#winner-screen1").css('background-image','url(images/scan/lotto-winner1.png)');}
						else if(barcodeGameName == "EuroMillions"){$("#winner-screen1").css('background-image','url(images/scan/em-winner1.png)');}
						else if(barcodeGameName == "Thunderball"){$("#winner-screen1").css('background-image','url(images/scan/tb-winner1.png)');}
						else if(barcodeGameName == "Lotto HotPicks"){$("#winner-screen1").css('background-image','url(images/scan/hp-winner1.png)');}
						else {$("#winner-screen1").css('background-image','url(images/scan/sc-winner1.png)');}

						$("#winner-screen1 h1").html("YOU'VE WON £" + prizeValueString + "<span>*</span>");
						if (ticketIsDbg){swapScratchcardForTicketText();}
						$("#winner-screen1").fadeIn('slow');
						break;

					case "WINNER_TIER_1am2":
						console.log("WINNER_TIER_1am2 - VALUE<=100");
						$("#winner-screen1").css('background-image','url(images/scan/lotto-winner1.png)');
						if(numberOfLuckyDipsWon == 1){$("#winner-screen1 h1").html("YOU'VE WON £" + prizeValueString + "<br>AND A LOTTO LUCKY DIP<span>*</span>").css("fontSize","56px").css("wordSpacing","2px").css("lineHeight","46px");}
						else {$("#winner-screen1 h1").html("YOU'VE WON £" + prizeValueString + "<br>AND " + numberOfLuckyDipsWon + " LOTTO LUCKY DIPS<span>*</span>").css("fontSize","56px").css("wordSpacing","2px").css("lineHeight","46px");}

						if (ticketIsDbg){swapScratchcardForTicketText();}
						$("#winner-screen1").fadeIn('slow');
						break;

					case "WINNER_TIER_1b":
						console.log("WINNER_TIER_1b - VALUE<=500");
						if(barcodeGameName == "Lotto"){$("#winner-screen1").css('background-image','url(images/scan/lotto-winner1.png)');}
						else if(barcodeGameName == "EuroMillions"){$("#winner-screen1").css('background-image','url(images/scan/em-winner1.png)');}
						else if(barcodeGameName == "Thunderball"){$("#winner-screen1").css('background-image','url(images/scan/tb-winner1.png)');}
						else if(barcodeGameName == "Lotto HotPicks"){$("#winner-screen1").css('background-image','url(images/scan/hp-winner1.png)');}
						else {$("#winner-screen1").css('background-image','url(images/scan/sc-winner1.png)');}

						$("#winner-screen1 h1").html("YOU'VE WON £" + prizeValueString + "<span>*</span>");
						$("#winner-screen1 h3").html("<h3>SIGN YOUR <span class='custom-sc-or-dbg-cap'>SCRATCHCARD</span> AND YOU CAN ASK THE RETAILER IF THEY ARE ABLE TO PAY YOUR PRIZE</h3>");
						if (ticketIsDbg){swapScratchcardForTicketText();}
						$("#winner-screen1").fadeIn('slow');
						break;

					case "WINNER_TIER_1bm2":
						console.log("WINNER_TIER_1bm2 - VALUE<=500");
						$("#winner-screen1").css('background-image','url(images/scan/lotto-winner1.png)');

						if(numberOfLuckyDipsWon == 1){$("#winner-screen1 h1").html("YOU'VE WON £" + prizeValueString + "<br>AND A LOTTO LUCKY DIP<span>*</span>").css("fontSize","56px").css("wordSpacing","2px").css("lineHeight","46px");}
						else{$("#winner-screen1 h1").html("YOU'VE WON £" + prizeValueString + "<br>AND " + numberOfLuckyDipsWon + " LOTTO LUCKY DIPS<span>*</span>").css("fontSize","56px").css("wordSpacing","2px").css("lineHeight","46px");}
						$("#winner-screen1 h3").html("<h3>SIGN YOUR <span class='custom-sc-or-dbg-cap'>SCRATCHCARD</span> AND YOU CAN ASK THE RETAILER IF THEY ARE ABLE TO PAY YOUR PRIZE</h3>");

						$("p.dbg-winner").css("paddingTop","35px");
						if (ticketIsDbg){swapScratchcardForTicketText();}
						$("#winner-screen1").fadeIn('slow');
						break;

					case "WINNER_TIER_2":
						if(barcodeGameName == "Lotto"){$("#winner-screen2").css('background-image','url(images/scan/lotto-winner2.png)');}
						else if(barcodeGameName == "EuroMillions"){$("#winner-screen2").css('background-image','url(images/scan/em-winner2.png)');}
						else if(barcodeGameName == "Thunderball"){$("#winner-screen2").css('background-image','url(images/scan/tb-winner2.png)');}
						else if(barcodeGameName == "Lotto HotPicks"){$("#winner-screen2").css('background-image','url(images/scan/hp-winner2.png)');}
						else {$("#winner-screen2").css('background-image','url(images/scan/sc-winner2.png)');}

						if (ticketIsDbg){swapScratchcardForTicketText();}
						$("#winner-screen2").fadeIn('slow');
						break

					case "WINNER_TIER_3":
						if(barcodeGameName == "Lotto"){$("#winner-screen3").css('background-image','url(images/scan/lotto-winner2.png)');}
						else if(barcodeGameName == "EuroMillions"){$("#winner-screen3").css('background-image','url(images/scan/em-winner2.png)');}
						else if(barcodeGameName == "Thunderball"){$("#winner-screen3").css('background-image','url(images/scan/tb-winner2.png)');}
						else if(barcodeGameName == "Lotto HotPicks"){$("#winner-screen3").css('background-image','url(images/scan/hp-winner2.png)');}
						else {$("#winner-screen3").css('background-image','url(images/scan/sc-winner2.png)');}

						if (ticketIsDbg){swapScratchcardForTicketText();}
						$("#winner-screen3").fadeIn('slow');
						break

					case "LOSER":
						$("#lose-screen").css('background-image',loseImages[Math.floor((Math.random() * loseImages.length))]);
						$("#lose-screen").fadeIn('slow');
						break

					case "LOSER_MOREDRAWS":
						$(".dbg-loser").html("Please keep your ticket as you have <br> more draws left to play");
						$("#lose-screen").css('background-image',loseImages[Math.floor((Math.random() * loseImages.length))]);
						$("#lose-screen").fadeIn('slow');
						break

					case "LOSER_CLAIMEXPIRED":
						$(".dbg-loser").html("The claim period for this ticket has expired.<br>Prize cannot be paid");
						$("#lose-screen").css('background-image',loseImages[Math.floor((Math.random() * loseImages.length))]);
						$("#lose-screen").fadeIn('slow');
						break

					case "BARCODE_NOT_RECOGNISED":
						//$("#error-barcode-not-recognised").fadeIn('slow');

						$(".generic-row1 h1").html("OOPS!");
						$(".generic-row2 h3").html("BARCODE NOT RECOGNISED");
						$(".generic-row2 p" ).html('Please try again');
						$("#error-screen-generic").fadeIn('slow');

						break

					/*/case "FIND_TICKET_BARCODE":
						$("#error-barcode-dbg-not-recognised").fadeIn('slow');
						break

					case "FIND_SCRATCHCARD_BARCODE":
						$("#error-barcode-sc-not-recognised").fadeIn('slow');
						break/*/

					case "ERROR_VIRN":
						$(".generic-row2 h3").html("THE NUMBER ENTERED WAS NOT RECOGNISED");
						$(".generic-row2 p" ).html('Please rescan your Scratchcard and enter the boxed four digit number as directed');
						$("#error-screen-generic").fadeIn('slow');
						break

					case "ERROR_ACTIVATEPACK":
						$(".generic-row2 h3").html("THIS SCRATCHCARD ISN'T CURRENTLY ACTIVE");
						$(".generic-row2 p" ).html('Please inform the retailer they need to confirm and activate<br>the pack that this ticket belongs to');
						$("#error-screen-generic").fadeIn('slow');
						break

					case "ERROR_NOTDBG":
						$(".generic-row1 h1").html("SORRY!");
						$(".generic-row2 h3").html("THIS TERMINAL IS FOR SCRATCHCARDS ONLY");
						$(".generic-row2 p" ).html('Please check your ticket on our website or at another National Lottery Outlet<br>www.national-lottery.co.uk');
						$("#error-screen-generic").fadeIn('slow');
						break

					case "ERROR":
						$("#error-screen-generic").fadeIn('slow');
						break

					case "ERROR_SENDTICKET":
						$(".generic-row2 h3").text("THERE'S A PROBLEM WITH THIS TICKET");
						$(".generic-row2 p" ).text('Please send the ticket to The National Lottery address on the back of the ticket');
						$("#error-screen-generic").fadeIn('slow');
						break

					case "ERROR_PREVPAID":
						$(".generic-row2 h3").text('THIS TICKET HAS BEEN PREVIOUSLY PAID');
						$(".generic-row2 p" ).text('');
						$("#error-screen-generic").fadeIn('slow');
						break

					case "DBG_SCREEN1":
						console.log("DBG_SCREEN1");
						swapScratchcardForTicketText();
						$("#dbg-screen1").fadeIn('slow');

						/*/ TEST /*/
						if(testing){$(".content-overlay .header").append(barcodeGameName + " | " + barcodeErrorCode + " | ");}
						/*/ TEST /*/

						break;

					case "DBG_SCREEN1_SELECTED":
						console.log("DBG_SCREEN1_SELECTED");
						$("#dbg-screen1").fadeOut('slow','swing',function(){
							submitVIRNData("DBG");
							//callData();
						});
						break;

					case "QR_DISPLAY_DATA":
						console.log("QR_DISPLAY_DATA");
						$("#QR_DISPLAY_DATA").fadeIn('slow');
						break;

					case "QR_ORDER_SEND":
						console.log("QR_ORDER_SEND");
						setHoldingScreenTimeout();
						hideExitButton();
						sendQRCode();
						$("#QR_DISPLAY_DATA").fadeOut('slow','swing',function(){
							changeScreen("QR_ORDER_SEND_COMPLETE");
						});
						break;
					case "QR_ORDER_SEND_COMPLETE":
						$("#QR_ORDER_SEND").fadeIn('slow');
						break;

					case "QR_ORDER_CLOSED":
						$(".content-overlay").fadeOut('slow','swing');
						$("#QR_ORDER_SEND").fadeOut('slow','swing',function(){
							changeScreen("QR_ORDER_CLOSED_COMPLETE");
						});
						break;
					case "QR_ORDER_CLOSED_COMPLETE":
						$("#QR_ORDER_CLOSED").fadeIn('slow');
						break;
				}
			}

			function hideAllScreens(){
				console.log("hideAllScreens()");
				$(".screen").hide();
			}

			/////////////////
			/*/ CALL DATA /*/
			/////////////////

			function callData(whichData){
				if(whichData == "barcode"){ // BARCODE || QRCODE
					if(isLive){
						ESMM.requestFromObserver("barcodeData", "/data/barcodeobserver/barcode.xml"); // BARCODE SCANNED
					} else {
						responseFromObserver('barcodeData','debug');
					}
				} else { // VIRN
					if(isLive){
						ESMM.requestFromObserver("inquiryResponse", "/data/inquirydetailsobserver/response.xml"); // VIRN ENTERED RESPONSE
					} else {
						responseFromObserver('inquiryResponse','debug');
					}
				}
			}

			/////////////////
			/*/ RESPONSES /*/
			/////////////////

			function responseFromObserver(id,text)
			{
				if(isLive){ESMM.setShowInterruptable('true');}

				console.log("Response From Observer: "+id+" - Starting Parsing:");
				var parser = new DOMParser();
				var doc = parser.parseFromString(text,'text/xml');
				var $doc = $(doc);
				console.log("Response From Observer - PARSED");

				//////////////////////
				/*/ SIGNED ON DATA /*/
				//////////////////////

				if(id == "signOnState"){
					if(isLive){
						if($doc.find('details').length > 0) {
							var xmldata = $doc.find('details');

							// NEW
							if(xmldata.attr('signedon') != "" && xmldata.attr('signedon') != null && xmldata.attr('signedon') != undefined){signedOn = xmldata.attr('signedon');}
							else {signedOn = xmldata.attr('signedOn');}

							cltIsDBG = xmldata.attr('iscltdbg');
						} else {
							console.log("XML Load Error - SignedOnStateData");
							changeScreen("ERROR");
						}
					} else {
						signedOn = 'true';
						cltIsDBG = testCltIsDBG;
					}
					signedOnStateXMLLoaded();
				}

				////////////////////
				/*/ BARCODE DATA /*/
				////////////////////

				else if(id == "barcodeData"){
					console.log("responseFromObserver(); barcode data recieved");

					if(isLive){
						if($doc.find('data').length > 0) {
							var xmldata = $doc.find('data');
							try{
								barcodeType		= xmldata.attr('type');
								barcodeValue	= xmldata.attr('value');
								barcodeGameName	= xmldata.attr('gameName');
								barcodeErrorCode= xmldata.attr('errcode');
								//barcodeMessage1	= xmldata.attr('message1');
								//barcodeMessage2	= xmldata.attr('message2');
							} catch(err) {
								console.log("Failed.");
								changeScreen("ERROR");
							}
						} else {
							console.log("Failed.");
							changeScreen("ERROR");
						}
					} else {
						barcodeType		= testBarcodeType; // ITF || QR (Scratchcard, DBG, EPlay)
						barcodeValue	= testBarcodeValue; // '1000001010101000';
						barcodeGameName = testBarcodeGameName; // 'SAMPLE GAME' || Lotto || EuroMillions || Thunderball || Lotto HotPicks;
						barcodeErrorCode= testBarcodeErrorCode;
						//barcodeMessage1 = 'Message 1';
						//barcodeMessage2 = 'Message 2';
					}

					/*/ BARCODE SCAN RESULTS /*/
					if(testing){$(".content-overlay .header").append(barcodeType + " | ");}

					if(barcodeType == 'ITF'){
						console.log("Barcode type = ITF (SC or DBG)");
						checkForBarcodeError(); // DBG ticket || Scratchcard
					} else if (barcodeType == 'CODE_128'){
						console.log("Barcode type = CODE_128");
						checkForBarcodeError(); // EPOS ticket
					}else if (barcodeType == 'QR_CODE'){
						console.log("Barcode type = QR (EPlay)");
						if(cltIsDBG == 'true'){actionQRcodeData();}
						else{changeScreen("ERROR_NOTDBG");}
					} else {
						changeScreen('BARCODE_NOT_RECOGNISED');
					}
				}

				/////////////////
				/*/ VIRN DATA /*/
				/////////////////

				else if (id == "inquiryResponse") {
					console.log("responseFromObserver(); inquiry data recieved");
					if(isLive){
						if($doc.find('response').length > 0) {
							var xmldata = $doc.find('response');
							try{
								inquiryGameName	     = xmldata.attr('gamename');
								inquiryResCode       = Number(xmldata.attr('rescode'));
								inquiryErrCode	     = Number(xmldata.attr('errcode'));
								inquiryPrizeValue	 = Number(xmldata.attr('prizevalue'));
								//inquiryGamePrice     = xmldata.attr('gameprice');
								//inquiryGameCloseDate = xmldata.attr('gameclosedate');
								//inquiryLastClaimDate = xmldata.attr('lastclaimdate');
								inquiryMessage1	     = Number(xmldata.attr('message1'));
								//inquiryMessage2	     = xmldata.attr('message2');
							} catch(err){
								console.log("Failed.");
								changeScreen("ERROR");
							}

						} else {
							console.log("Failed.");
							changeScreen("ERROR");
						}
					} else {
						inquiryGameName	     = testBarcodeGameName;
						inquiryResCode       = Number(testInquiryResultCode);
						inquiryErrCode	     = Number(testInquiryErrorCode);
						inquiryPrizeValue    = Number(testInquiryPrizeValue);
						//inquiryGamePrice     = '200';
						//inquiryGameCloseDate = '0000';
						//inquiryLastClaimDate = '0000';
						inquiryMessage1	     = Number(testInquiryMessage1);
						//inquiryMessage2	     = "Message 2";
					}
					displayInquiryData();
				}
			}


			function checkForBarcodeError(){

				checkTicketGameType();

				// IS THIS GENERIC FOR SC AND DBG OR SPECIFIC FOR EACH ???
				// CHECK FOR ERROR IN DATA

				console.log("++ checkForBarcodeError",barcodeErrorCode);
				if(testing){$(".content-overlay .header").append(" | EC:" + barcodeErrorCode+" | GN:"+barcodeGameName+" | "+ticketIsDbg);}

				if (barcodeErrorCode == '0'){
					console.log("checkForBarcodeError = no error");
					actionBarcodeData();
				}
				else if (barcodeErrorCode == '-2'){
					console.log("barcode = -2");
					if(barcodeValue.length == 18 && cltIsDBG == 'false'){
						changeScreen("ERROR_NOTDBG");
					} else {
						changeScreen('ERROR_SENDTICKET');
					}
				}
				else if (barcodeErrorCode == '-4'){
					console.log("barcode = -4");
					if(cltIsDBG == 'true'){
						$("#error-screen-generic h3").html("YOUR QR CODE HAS NOT BEEN RECOGNISED"); // INCORRECT QRCODE VERSION
						$("#error-screen-generic p").html("Please download the latest version of our app");
						changeScreen('ERROR');
					}
					else {
						changeScreen("ERROR_NOTDBG");
					}
				}
				else {
					//if (ticketIsDbg){changeScreen('FIND_TICKET_BARCODE');}
					//else {changeScreen('FIND_SCRATCHCARD_BARCODE');}
					changeScreen('BARCODE_NOT_RECOGNISED');
					//changeScreen("ERROR");
				}
			}


			function checkTicketGameType(){
				console.log("checkTicketGameType()");
				if(barcodeGameName == "Lotto" || barcodeGameName == "EuroMillions" || barcodeGameName == "Thunderball" || barcodeGameName == "Lotto HotPicks"){
					ticketIsDbg = true;
				} else{
					ticketIsDbg = false;
				}
			}


			function actionBarcodeData(){
				if(ticketIsDbg){
					if (cltIsDBG == 'true'){
						changeScreen('DBG_SCREEN1');
					} else {
						changeScreen('ERROR_NOTDBG');
					}
				} else {
					console.log("GAME =",barcodeGameName," (Scratchcard)");
					changeScreen('SC_SCREEN1');
				}
			}

			function swapScratchcardForTicketText(){
				$(".custom-sc-or-dbg").text("ticket");
				$(".custom-sc-or-dbg-cap").text("TICKET");
			}

			function actionQRcodeData(){
				analyseQrcodeData();
			}


			//////////////////////
			/*/ QRCODE RECEIVE /*/
			//////////////////////


			function analyseQrcodeData(){
				console.log("Analyse QR Code Data: "+barcodeValue);
				var noErrors = true;
				var array = barcodeValue.replace(/\s+/g, '').split('/'); // remove spaces
				//var array = barcodeValue.split('/');
				array.pop(); // removes last checksum so can search for 'A' etc if it starts with that!

				console.log("QR Data Array: "+array);

				// FIXED POSITION
				//console.log("analyseQrcodeData: Site ID:", array[0]);
				//console.log("analyseQrcodeData: Version:", array[1]);
				//console.log("analyseQrcodeData: GameType", array[2]); // "W" + 8(Lotto) 12(ThunderBall) 20(Euro Millions) 27(Lotto HotPick)

				var gameNameData = '';
				if(array[2] == "W8"){gameNameData = "Lotto";}
				else if(array[2] == "W20"){gameNameData = "EuroMillions"}
				else if(array[2] == "W12"){gameNameData = "ThunderBall"}
				else if(array[2] == "W27"){gameNameData = "Lotto HotPicks"}
				else {
					console.log("GAME NAME UNKNOWN VALUE:",array[2]);
					changeScreen("ERROR");
					noErrors = false;
				}
				console.log("GAME TITLE: "+gameNameData);

				// ANY POSITION
				var boardData; // B = boards = "B" + number
				var drawsData; // D = draws = "D" + D4 = Wed, D467 = Wed, Fri and Sat -Thunderball /D36 – For Tue and Friday /D0 – Next available Draw day
				var weeksData; // N = weeks = "N" + N1 to N8 ( for Lotto) N1 to N4 ( for EuroMillion)
				var priceData; // A = A00150 = £1.50 wager, A11200 = £112.00 wager

				var sArray = []; // S = selected numbers (2 digit format) /S01020304050611/S12131415161718
				//var vData; // V = playslip version = "V" + EuroMillions(216) || Lotto HotPicks(178) || Lotto(7) || Thunderball(088)
				//var pData; // P = picks /P223 – 3 boards. With first 2 are Pick 2 and 3rd boards as Pick 3.
				//var lData; // L = luckydip
				//var xData; // X = external data /X1delayAmt56789123
				//var priceData; // A90F0B46 checksum

				var dayArray = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];

				if (noErrors){
					for (i = 3; i < array.length; i++) {

						switch(array[i].charAt(0)) {

							case "B": // populates boards
								boardData = array[i].slice(1);
								console.log("NUMBER OF BOARDS: "+boardData);
								break;

							case "D": // gets included days string
								drawsData = array[i].slice(1);
								dayString = '';
								for (j = 0; j < drawsData.length; j++) {
									if(dayArray[drawsData.charAt(j)-1] != undefined){
										dayString+=dayArray[drawsData.charAt(j)-1]
										if(j <= drawsData.length-3){dayString += ", "}
										else if(j == drawsData.length-2){dayString += " & "}
									}

									if(dayString == ''){
										dayString = "Next Available";
									}
								}
								console.log("DAYS: "+dayString);
								break;

							case "N": // gets number of weeks
								weeksData = array[i].slice(1);
								console.log("NUMBER OF WEEKS: "+weeksData);
								break;

							case "A": // gets ticket price
								priceData = "£" + parseInt(array[i].slice(1,-2), 10); // remove first char and pence fields (assuming no pence required)
								console.log("PRICE: "+priceData);
								break;

							case "S": // populates array of numbers
								console.log("analyseQrcodeData: NUMBERS", array[i]);
								sArray.push(array[i]);
								break;

							case "L": // ...
								console.log("Lucky Dip Identifier Found: "+array[i]);
								break;

							case "P": // ...
								console.log("Picks Identifier Found: "+array[i]);
								break;

							case "V": // ...
								console.log("V Identifier Found: "+array[i]);
								break;

							default:
								console.log("analyseQrcodeData: "+array[i]);
								console.log("Default SWITCH Error",array[i].charAt(0));
								//noErrors = false;
								//changeScreen("ERROR");
						}
					}
				}

				if(boardData == null || drawsData == null || weeksData == null || priceData == null){noErrors = false;console.log("No data!");}

				if (noErrors){
					//$('.ticket-data1').append(": "+gameNameData);
					//$('.ticket-data2').append(": "+boardData);
					$('.ticket-data3').html("<span class='bold'>Draw days: </span>" + dayString);
					$('.ticket-data4').html("<span class='bold'>Number of weeks: </span>" + weeksData);
					$('.ticket-data5').text(priceData+".00");

					switch(gameNameData) {

						case "Lotto":
							$('.ticket-data1').text("1 LOTTO TICKET INCLUDING");
							if(boardData == 1){
								$('.ticket-data2').text(boardData + " LINE & " + boardData + " MILLIONAIRE RAFFLE ENTRY");
							} else {
								$('.ticket-data2').text(boardData + " LINES & " + boardData + " MILLIONAIRE RAFFLE ENTRIES");
							}
							break

						case "EuroMillions":
							$('.ticket-data1').text("1 EUROMILLIONS TICKET INCLUDING");
							$('.subject-to-validation').html("<p>Games Rules and Procedures and<br> Game Specific Rules for non-cash prizes apply</p>").css("top", "-20px");
							$('.subject-to-validation p').css("top", "-20px");
							if(boardData == 1){
								$('.ticket-data2').text(boardData + " LINE & " + boardData + " UK MILLIONAIRE MAKER CODE");
							} else {
								$('.ticket-data2').text(boardData + " LINES & " + boardData + " UK MILLIONAIRE MAKER CODES");
							}
							break

						case "ThunderBall":
							$('.ticket-data1').text("1 THUNDERBALL TICKET INCLUDING");
							if(boardData == 1){
								$('.ticket-data2').text(boardData + " LINE");
							} else {
								$('.ticket-data2').text(boardData + " LINES");
							}
							break

						case "Lotto HotPicks":
							$('.ticket-data1').text("1 LOTTO HOTPICKS TICKET INCLUDING");
							if(boardData == 1){
								$('.ticket-data2').text(boardData + " LINE");
							} else {
								$('.ticket-data2').text(boardData + " LINES");
							}
							break

						default:
							noErrors = false;
							changeScreen("ERROR");
							console.log("Game Name Data NULL");
					}
				}

				if(noErrors){
					changeScreen("QR_DISPLAY_DATA");;
				} else {
					console.log("ERRORS DETECTED IN QR ANALYSIS");
					changeScreen("ERROR");
				}
			}

			function sendQRCode(){
				console.log("ESMM.send('virtualplayslip', barcodeValue);");
				//ESMM.send("virtualplayslip", "LOT79:W8V7N8D47B7A22400L0000000S0209262731320413192426350708162741450");
				if(isLive){
					ESMM.send("virtualplayslip", barcodeValue);
				}
			}


			///////////////////////
			/*/ INQUIRY RESULTS /*/
			///////////////////////

			function calculatePrizeValueInPounds(num){
				var prizeValue = String(Number(num/100).toFixed(2));
				if(prizeValue.charAt(prizeValue.length - 2) == "0"){
					prizeValue = prizeValue.slice(0,-3);
				}
				prizeValueString = String(prizeValue);
				prizeValueInPounds = Number(prizeValue);
			}



			function displayInquiryData(){
				/*/ TEST /*/
				if(testing){$(".content-overlay .header").append(" " + inquiryGameName+" | "+inquiryErrCode+" | " + inquiryPrizeValue/100 + " | " + Number(inquiryMessage1));}
				/*/ TEST /*/

				checkTicketGameType();

				var errorCode = Number(inquiryErrCode);
				var resultCode = Number(inquiryResCode);
				calculatePrizeValueInPounds(inquiryPrizeValue);
				numberOfLuckyDipsWon = Number(inquiryMessage1);

				console.log("displayInquiryData ||",barcodeGameName,"|| ticketIsDbg =",ticketIsDbg)
				console.log("displayInquiryData || Error code:",errorCode,"|| Prize value:",prizeValueInPounds)

				if(resultCode == 0){
					switch(errorCode){
						case 1: checkValueOfWinAndRedirect(); break; // SC ONLY

						case 2:
							if(ticketIsDbg){checkValueOfWinAndRedirect();} // NEW
							else{changeScreen("WINNER_TIER_3");}
							break;

						case 3:  changeScreen("LOSER"); break;
						case 4:  changeScreen("ERROR_PREVPAID"); break;
						case 5:  changeScreen("ERROR_PREVPAID"); break;
						case 6:  changeScreen("WINNER_TIER_3"); break;

						case 7:
							if(ticketIsDbg){changeScreen("WINNER_TIER_2");} // NEW
							else {changeScreen("WINNER_TIER_3");}
							break;

						case 8:  changeScreen("WINNER_TIER_3"); break; // NEW
						case 9:  changeScreen("ERROR_SENDTICKET"); break;

						case 10:
							if(ticketIsDbg){changeScreen("LOSER_MOREDRAWS");} // NEW.
							else{changeScreen("ERROR");} // NEW.
							break;

						case 11:
							if(ticketIsDbg){changeScreen("ERROR");}
							else {changeScreen("ERROR_VIRN");}
							break;

						case 12:
							if(ticketIsDbg){changeScreen("ERROR_PREVPAID");} // NEW.
							else {changeScreen("ERROR");} // NEW.
							break;

						case 13:
							if(ticketIsDbg){changeScreen("LOSER_CLAIMEXPIRED");}
							else {changeScreen("ERROR");}
							break;

						case 15:
							if(ticketIsDbg){changeScreen("ERROR");}
							else {changeScreen("ERROR_SENDTICKET");}
							break;

						case 16:
							//if(ticketIsDbg){changeScreen("ERROR");} // NEW.
							//else {changeScreen("ERROR_SENDTICKET");} // NEW.
							changeScreen("ERROR");
							break;

						case 19: changeScreen("ERROR_SENDTICKET"); break; // NEW.
						case 21: changeScreen("LOSER_MOREDRAWS"); break;
						case 22: changeScreen("ERROR_SENDTICKET"); break;
						case 22: changeScreen("ERROR_SENDTICKET"); break;
						case 23: changeScreen("ERROR_PREVPAID"); break;

						case 24:
							if(ticketIsDbg){changeScreen("ERROR_PREVPAID");} // NEW.
							else {changeScreen("ERROR_SENDTICKET");} // NEW.
							break;

						case 28: changeScreen("ERROR_ACTIVATEPACK"); break;

						case 29:
							if(ticketIsDbg){changeScreen("WINNER_TIER_3");}
							else {changeScreen("ERROR_ACTIVATEPACK");} // SC ONLY
							break;

						case 31: changeScreen("ERROR_SENDTICKET"); break;

						case 32:
							if(ticketIsDbg){changeScreen("LOSER");}
							else {checkValueOfWinAndRedirect();} // SC ONLY
							break;

						case 39: changeScreen("ERROR_SENDTICKET"); break;
						case 43: changeScreen("ERROR_SENDTICKET"); break;
						case 45: changeScreen("WINNER_TIER_2"); break;
						case 46: changeScreen("WINNER_TIER_3"); break;
						case 64: changeScreen("ERROR_SENDTICKET"); break;
						case 72: changeScreen("ERROR_SENDTICKET"); break;
						case 73: changeScreen("ERROR"); break; // NEW.
						case 75: changeScreen("WINNER_TIER_2"); break;

						default: changeScreen("ERROR");
					}
				}
				else if (resultCode == -1){
					changeScreen("ERROR");
					//changeScreen('BARCODE_NOT_RECOGNISED');
					/*/if (ticketIsDbg){changeScreen('FIND_TICKET_BARCODE');console.log("FIND_TICKET_BARCODE");}
					else {changeScreen('FIND_SCRATCHCARD_BARCODE');console.log("FIND_SCRATCHCARD_BARCODE");}/*/
				}
				else {changeScreen("ERROR_SENDTICKET");} // We're unable to check, send ticket
			}

			function checkValueOfWinAndRedirect(){ // DBG + ERROR CODE 2
				console.log("checkValueOfWinAndRedirect()",prizeValueInPounds,numberOfLuckyDipsWon);

				if (prizeValueInPounds == 0) { // NEW
					changeScreen("WINNER_TIER_0"); // MIGHT HAVE TO CHECK GAMENAME FOR HIGHTIER EM/TB/HP WIN?
				}
				else if (prizeValueInPounds <= 100) {
					if(numberOfLuckyDipsWon >= 1){changeScreen("WINNER_TIER_1am2");}
					else {changeScreen("WINNER_TIER_1a");}
				}
				else if (prizeValueInPounds <= 500) {
					if(numberOfLuckyDipsWon >= 1){changeScreen("WINNER_TIER_1bm2");}
					else {changeScreen("WINNER_TIER_1b");}
				}
				else if (prizeValueInPounds <= 50000) { // ISSUED FROM POST OFFICE?
					changeScreen("WINNER_TIER_2");
				}
				else {
					changeScreen("ERROR");
				}
			}

			//////////////////////
			/*/ HOLDING SCREEN /*/
			//////////////////////

			function setHoldingScreenTimeout(){
				if(isLive){ESMM.setShowInterruptable('false');}
				startHoldingScreenTimeout();
			}

			function startHoldingScreenTimeout() {
				//console.log("startTimeout();" + this.touchTimeout);
				clearTimeout(this.holdingScreenTimer);
				var _this = this;
				this.holdingScreenTimer = setTimeout(function(){
					//ESMM.setShowInterruptable('true');
					//ESMM.showFinished();
					ESMM.setShowInterruptable('true');
					window.setTimeout(function(){ESMM.showFinished();}, 50);

				}, this.holdingScreenTimeout);
			};

			///////////////
			/*/ GENERIC /*/
			///////////////

			function hideExitButton(){$('.exit-btn').hide();}
			function showExitButton(){$('.exit-btn').show();}

			///////////////
			/*/ ANIMATE /*/
			///////////////

			/*/function animateResults(){

				$(".result-animation1").hide();
				$(".result-animation2").hide();
				$(".result-animation-content h1").hide();
				$(".result-animation-content h2").hide();
				$(".result-animation1").delay(000).fadeIn(1500);
				$(".result-animation2").delay(500).fadeIn(1000);
				$(".result-animation-content h1").delay(1000).fadeIn(750);
				$(".result-animation-content h2").delay(1250).fadeIn(750);
			}/*/

			////////////////////////
			/*/ PHYSICAL BUTTONS /*/
			////////////////////////

			function onF4Pressed(){
				console.log("F4 Pressed");
				ESMM.setShowInterruptable('true');
				window.setTimeout(function(){ESMM.shutdownPlayer();}, 50);
			}

			///////////
			/*/ END /*/
			///////////

		</script>

	</head>

	<body onLoad="init()">

    	<!------------->
        <!-- DEFAULT -->
        <!------------->

        <div class="exit-btn"></div>

        <div class="content-overlay">
			<div class="header"></div>
            <div class="main-content"></div>
            <div class="footer"></div>
        </div>

        <div id='' class="screen">
        </div>

        <!--------------------->
        <!-- QR_DISPLAY_DATA -->
        <!--------------------->

        <div id="QR_DISPLAY_DATA" class="screen">
          <div class="generic-content-no-header">
          	<div class="qr-content">
              <h1>TICKET DETAILS</h1>
                <p class="ticket-data1">TICKET TYPE</p>
                <p class="ticket-data2">NUMBER OF LINES</p>
                <p class="ticket-data3"><span class="bold">Draw days: </span></p>
                <p class="ticket-data4"><span class="bold">Number of weeks: </span></p>
                <p class="ticket-data5">PRICE</p>

			</div>
            <div class="scan-qr-confirm-btn"></div>
                <div class="subject-to-validation"><p>Game Rules & Procedures apply</p></div>
          </div>
        </div>

        <!------------------->
        <!-- QR_ORDER_SEND -->
        <!------------------->

        <div id="QR_ORDER_SEND" class="screen">
			<div class="generic-content-no-header">
              <div class="qr-content">
                <h1>READY AND WAITING</h1>
                <h3>JUST PAY AND COLLECT AT THE TILL</h3>
                    <p><img src="images/generic/tnl-logo.png" width="136" height="170" alt=''/></p>
                    <div class="dbg-screen-close-btn-closed"></div>
            </div>
            </div>
        </div>

        <!--------------------->
        <!-- QR_ORDER_CLOSED -->
        <!--------------------->

        <div id="QR_ORDER_CLOSED" class="screen">
			<div class="full-screen">
                <h1>ALL NATIONAL <br>LOTTERY GAMES <br>ARE NOW <br>AVAILABLE IN <br>THIS STORE</h1>
			</div>
        </div>

        <!---------------->
        <!-- SC_SCREEN1 -->
        <!---------------->

        <div id="SC_SCREEN1" class="screen">
			<div class="generic-content-no-header">
                <div id="keypad-content">
                    <div id="keypad-column1">
                        <h1>ENTER CODE</h1>
                        <p class="sc-home-instruction">Scratch
                        off the coating on the front <br>
                        of your Scratchcard and find the boxed
                        <br>
                        four digit code.</p>
                        <p class="sc-home-instruction"><br>
                        If you're a winner, others may see. Remember to always protect your privacy.</p>
                        <div class="sc-screen1-continue-btn"></div>
                    </div>

                    <div id="keypad-column2">
                    </div>
                </div>
            </div>
        </div>

    	<!--------------->
        <!-- SC_KEYPAD -->

        <!--------------->

    	<div id="keypad-screen" class="screen">
			<div class="generic-content-no-header">
                <div id="keypad-content">

                    <div id="keypad-column1">
                        <div id="keypad-column1-row1">
                            <h1>ENTER CODE</h1>
                            <h3>&nbsp;</h3>
                        </div>
                        <div id="keypad-column1-row2">
                            <textarea id="textbox1" rows="1" cols="1" maxlength="1" disabled='disabled'></textarea>
                            <textarea id="textbox2" rows="1" cols="1" maxlength="1" disabled='disabled'></textarea>
                            <textarea id="textbox3" rows="1" cols="1" maxlength="1" disabled='disabled'></textarea>
                            <textarea id="textbox4" rows="1" cols="1" maxlength="1" disabled='disabled'></textarea>
                        </div>
                        <div id="keypad-column1-row3">
                          <div class="key-enter"></div>
                        </div>
                    </div>

                    <div id="keypad-column2">
                        <div id="btn1" class="key">1</div>
                        <div id="btn2" class="key">2</div>
                        <div id="btn3" class="key">3</div>
                        <div id="btn4" class="key">4</div>
                        <div id="btn5" class="key">5</div>
                        <div id="btn6" class="key">6</div>
                        <div id="btn7" class="key">7</div>
                        <div id="btn8" class="key">8</div>
                        <div id="btn9" class="key">9</div>
                        <div id="btnDelete" class="key-special key-clear">CLEAR</div>
                        <div id="btn0" class="key key0">0</div>
                        <div id="btnClear" class="key-special key-delete">DELETE</div>
                    </div>

                </div>
            </div>
        </div>


        <!------------------------->
        <!-- DBG_SCREEN1 -->
        <!------------------------->

		<div id="dbg-screen1" class="screen">
			<div class="generic-content-no-header">
                <div class="dbg-content">
                    <h1>FINGERS CROSSED</h1>
                    <h3>IF YOU'RE A WINNER, OTHERS MAY SEE</h3>
                    <p class="dbg-check">Remember to always protect your privacy</p>
                </div>
                <div class="dbg-screen1-continue-btn"></div>
            </div>
		</div>

        <!-------------------->
        <!-- WINNING TIER 1 -->
        <!-------------------->

		<div id="winner-screen1" class="screen">
			<div class="generic-content-no-header">
				<div class="dbg-content">
                    <h1>YOU'RE A WINNER*</h1>
                    <h3>SIGN YOUR <span class="custom-sc-or-dbg-cap">SCRATCHCARD</span> AND<br>COLLECT PRIZE AT TILL</h3>
                	<p class="dbg-winner">See the back of your <span class="custom-sc-or-dbg">Scratchcard</span> for more details</p>

                </div>
                <div class="dbg-screen-close-btn"></div>
                <div class="subject-to-validation"><p>*Subject to validation</p></div>
              </div>
		</div>


        <!-- WINNING TIER 2 -->


		<div id="winner-screen2" class="screen">
			<div class="generic-content-no-header">
				<div class="dbg-content">
                  <h1>YOU'RE A WINNER!*</h1>
                  <h3>SIGN YOUR <span class="custom-sc-or-dbg-cap">SCRATCHCARD</span> AND CLAIM YOUR PRIZE AT A DESIGNATED NATIONAL LOTTERY POST OFFICE</h3>
                  <p class="dbg-winner">See the back of your <span class="custom-sc-or-dbg">Scratchcard</span> for more details</p>
				</div>
				<div class="dbg-screen-close-btn"></div>
                <div class="subject-to-validation"><p>*Subject to validation</p></div>
			</div>
		</div>


        <!-- WINNING TIER 3 -->


        <div id="winner-screen3" class="screen">
          <div class="generic-content-no-header">
				<div class="dbg-content">
					<h1>YOU'RE A WINNER!*</h1>
                    <h3>SIGN YOUR <span class="custom-sc-or-dbg-cap">SCRATCHCARD</span> AND RING US</h3>
                	<p class="dbg-winner">See the back of your <span class="custom-sc-or-dbg">Scratchcard</span> for more details</p>
            	</div>
            	<div class="dbg-screen-close-btn"></div>
                <div class="subject-to-validation"><p>*Subject to validation</p></div>
            </div>
        </div>


        <!-- NOT A WINNER -->


		<div id="lose-screen" class="screen">
			<div class="generic-content-no-header">
				<div class="dbg-content">
					<h1>NOT A WINNER <br> THIS TIME. BUT...</h1>
					<p class="dbg-loser">You've helped change lives across the UK <br> by supporting National Lottery Projects</p>
              </div>
                <div class="dbg-screen-close-btn"></div>
			</div>
        </div>


        <!-- INCORRECT VIRN ENTRY


		<div id="error-screen-virn" class="screen">
			<div class="generic-content-no-header">
                <div id="keypad-content">
                  <div id="keypad-column1">
                    <h1>ENTER CODE</h1>
                        <p class="sc-home-instruction">Scratch
                        off the coating on the front <br>
                        of your Scratchcard and find the boxed
                        <br>
                        four digit code.</p>
                    </div>

	//title="The four digit number you entered was not recognised"
	//message="Please rescan your Scratchcard and re-enter the four digit number as directed"

                    <div id="keypad-column2">
                    </div>
                </div>
            </div>
		</div>-->


        <!-- INCORRECT BARCODE -->

		<div id="error-barcode-not-recognised" class="screen">
        	<div class="generic-content-no-header">
                <div class="dbg-content">
                    <h1>OOPS! BARCODE<br>
                    NOT RECOGNISED</h1>
                    <p>Please try again</p>
              </div>
            </div>

			<!--div class="generic-content-no-header">
				<div class="dbg-content">
                  <h1>OOPS!</h1>
                  <h3>BARCODE NOT RECOGNISED</h3>
                  <p>Please try again</p>
				</div>
			</div-->
		</div>


		<!--div id="error-barcode-sc-not-recognised" class="screen">
			<div class="generic-content-no-header">
            	<h1>BARCODE<br>
           	    NOT<br>
           	    RECOGNISED</h1>
            </div>
		</div>

	<div id="error-barcode-dbg-not-recognised" class="screen">
			<div class="generic-content-no-header">
           	  <h1>BARCODE<br>
           	    NOT<br>
           	    RECOGNISED</h1>
           	    <p>Make sure you're using the one on <br>
       	        the front of the ticket</p>
            </div>
		</div-->


        <!-- CUSTOM ERROR -->


		<!--div id="error-screen-custom" class="screen">
        	<div class="header"></div>
			<div class="main-content">
                <h1>BARCODE NOT RECOGNISED CUSTOM</h1>
                <p>Please try again later.</p>
          </div>
        </div-->


        <!-- GENERIC ERROR -->


		<div id="error-screen-generic" class="screen">
			<div class="generic-content-no-header">
            	<div class="generic-row1"><h1>UH-OH!</h1></div>
            	<div class="generic-row2">
                	<h3>WE'RE UNABLE TO CHECK RIGHT NOW</h3>
                	<p>Please try again later</p>
                </div>
            	<div class="generic-row3"><img src="images/generic/logo-horiz.png" width="150" height="90" alt=''/></div>
				<div class="generic-row4"><div class="dbg-screen-close-btn"></div></div>
            </div>
        </div>


        <!-- END -->


	</body>

</html>